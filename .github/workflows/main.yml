name: BPB-Worker-Panel é«˜å¼ºåº¦æ··æ·†å·¥ä½œæµ
on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *"  # æ¯æ—¥å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œ
permissions:
  contents: write
jobs:
  build-obfuscate:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ä»…æ‹‰å–æœ€æ–°æäº¤ï¼ŒåŠ å¿«é€Ÿåº¦
      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"  # æŒ‡å®šLTSç‰ˆæœ¬ï¼Œç¡®ä¿å…¼å®¹æ€§
      - name: å®‰è£…ç³»ç»Ÿä¾èµ–ä¸æ··æ·†å·¥å…·
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip  # ç”¨äºè§£å‹èµ„äº§åŒ…
          npm install -g javascript-obfuscator@latest  # å®‰è£…æœ€æ–°æ··æ·†å·¥å…·
      - name: å…‹éš†BPB-Worker-Panelä»“åº“ï¼ˆè·å–æœªæ··æ·†ä»£ç ï¼‰
        run: |
          # å…‹éš†ä»“åº“åˆ°ä¸´æ—¶ç›®å½•ï¼Œé¿å…ä¸å½“å‰ä»“åº“å†²çª
          git clone https://github.com/bia-pain-bache/BPB-Worker-Panel.git bpb-source
          # åˆ‡æ¢åˆ°mainåˆ†æ”¯ï¼ˆç¡®ä¿è·å–æœ€æ–°ä»£ç ï¼‰
          cd bpb-source && git checkout main && cd ..
          # æ£€æŸ¥å…‹éš†åçš„æ–‡ä»¶ç»“æ„
          if [[! -d "bpb-source/src" ]]; then
            echo "âŒ å…‹éš†å¤±è´¥ï¼Œæœªæ‰¾åˆ°srcç›®å½•"
            exit 1
          fi
          echo "âœ… æˆåŠŸå…‹éš†ä»“åº“åˆ° bpb-source/"
      - name: å®šä½æœªæ··æ·†çš„ä¸»JSæ–‡ä»¶
        run: |
          # æœç´¢srcç›®å½•ä¸‹çš„æ‰€æœ‰JSæ–‡ä»¶ï¼ˆå¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´è·¯å¾„ï¼‰
          SOURCE_FILE=$(find bpb-source/src -type f -name "*.js" | grep -v "_obfuscated.js" | head -n 1)
          if [[ -z "$SOURCE_FILE" ]]; then
            echo "âŒ æœªæ‰¾åˆ°æœªæ··æ·†çš„JSæ–‡ä»¶ï¼Œæ£€æŸ¥ä»“åº“ç»“æ„"
            exit 1
          fi
          echo "âœ… ä¸»æ–‡ä»¶è·¯å¾„ï¼š$SOURCE_FILE"
          echo "::set-output name=source_file::$SOURCE_FILE"
      - name: æ‰§è¡Œé«˜å¼ºåº¦æ··æ·†ï¼ˆç”¨æˆ·æŒ‡å®šå‚æ•°ï¼‰
        run: |
          SOURCE_FILE=${{ steps.å®šä½æœªæ··æ·†çš„ä¸»JSæ–‡ä»¶.outputs.source_file }}
          OUTPUT_FILE="æ··æ·†/worker.js"  # ç›®æ ‡æ–‡ä»¶å
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p $(dirname "$OUTPUT_FILE")
          # æ‰§è¡Œæ··æ·†å‘½ä»¤ï¼ŒåŒ…å«ç”¨æˆ·æ‰€æœ‰é«˜å¼ºåº¦å‚æ•°
          javascript-obfuscator "$SOURCE_FILE" --output "$OUTPUT_FILE" \
            --compact true \
            --control-flow-flattening true \
            --control-flow-flattening-threshold 1 \
            --dead-code-injection true \
            --dead-code-injection-threshold 1 \
            --identifier-names-generator hexadecimal \
            --rename-globals true \
            --string-array true \
            --string-array-encoding "rc4" \
            --string-array-threshold 1 \
            --transform-object-keys true \
            --unicode-escape-sequence true
          # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          if [[! -f "$OUTPUT_FILE" ]]; then
            echo "âŒ æ··æ·†å¤±è´¥ï¼Œæœªç”Ÿæˆè¾“å‡ºæ–‡ä»¶"
            exit 1
          fi
          echo "âœ… é«˜å¼ºåº¦æ··æ·†å®Œæˆï¼š$SOURCE_FILE -> $OUTPUT_FILE"
      - name: æäº¤æ··æ·†ç»“æœåˆ°ä»“åº“
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: 'ğŸ”’ é«˜å¼ºåº¦æ··æ·†BPB-Worker-Panelä»£ç '
          files: |
            æ··æ·†/worker.js  # ä»…æäº¤æ··æ·†åçš„æ–‡ä»¶ï¼Œä¿æŒä»“åº“æ•´æ´
          push_options: '--set-upstream'
