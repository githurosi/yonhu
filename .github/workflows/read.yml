name: BPB Panel èµ„äº§æ··æ·†ä¸é‡å‘½å
on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *" 

permissions:
  contents: write

jobs:
  build-obfuscate:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: å®‰è£…æ··æ·†å·¥å…·
        run: |
          npm install -g javascript-obfuscator

      - name: ä¸‹è½½å¹¶è§£å‹èµ„äº§åˆ°æœªæ··æ·†æ–‡ä»¶å¤¹
        run: |
          REPO_OWNER="bia-pain-bache"
          REPO_NAME="BPB-Worker-Panel"
          rm -rf unobfuscated/*
          response=$(curl -s https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases/latest)
          DOWNLOAD_URL=$(echo "$response" | jq -r '.assets[] | select(.name == "worker.zip") | .browser_download_url')
          if [[ -z "$DOWNLOAD_URL" ]]; then
            echo "âŒ æœªæ‰¾åˆ° worker.zip"
            exit 1
          fi
          mkdir -p unobfuscated
          curl -sL "$DOWNLOAD_URL" -o unobfuscated/worker.zip
          unzip -q unobfuscated/worker.zip -d unobfuscated/
          echo "âœ… èµ„äº§è§£å‹å®Œæˆ"

      - name: æ··æ·†å¹¶é‡å‘½åä¸º worker.js
        run: |
          mkdir -p æ··æ·†
          SOURCE_FILE=$(find unobfuscated -type f -name "*.js" | grep -v "_obfuscated.js" | head -n 1)
          if [[ -z "$SOURCE_FILE" ]]; then
            echo "âŒ æœªæ‰¾åˆ°æœªæ··æ·†çš„JSæ–‡ä»¶"
            exit 1
          fi
          OUTPUT_NAME="worker.js" 
          # æŒ‰ç…§é…ç½®æ·»åŠ æ··æ·†é€‰é¡¹
          javascript-obfuscator "$SOURCE_FILE" --output "æ··æ·†/$OUTPUT_NAME" \
            --compact true \
            --disable-formatted-output  # ç¦æ­¢æ ¼å¼åŒ–ï¼Œå¯¹åº”ç¦æ­¢æ ¼å¼åŒ–é€‰é¡¹
            --disable-console-output  # ç¦æ­¢æ§åˆ¶å°è¾“å‡º
            --disable-debugger-statement  # è¿‘ä¼¼ç¦æ­¢æ§åˆ¶å°è°ƒè¯•ï¼ˆæ— å®Œå…¨å¯¹åº”é€‰é¡¹ï¼Œè¯¥é€‰é¡¹ç¦æ­¢è°ƒè¯•è¯­å¥ï¼‰
            --transform-numbers-to-expressions true  # æ•°å€¼è½¬è¡¨è¾¾å¼
            --optimize-code true  # ä¼˜åŒ–ä»£ç ç»“æ„
            --split-strings true  # åˆ†å‰²å­—ç¬¦ä¸²
            --unicode-escape-sequence true  # è½¬ä¹‰Unicodeï¼ˆè¿‘ä¼¼é€‰é¡¹ï¼ŒåŸé€‰é¡¹åç§°å·®å¼‚ï¼‰
            --rename-global-variables true  # é‡å‘½åå…¨å±€å˜é‡
            --rename-property-names true  # é‡å‘½åæ–¹æ³•&å±æ€§
            --dead-code-injection true  # æ³¨å…¥æ­»ä»£ç 
            --dead-code-injection-threshold 0.4  # æ³¨å…¥æ­»ä»£ç é˜ˆå€¼
            --control-flow-flattening true  # æ§åˆ¶æµå¹³å¦åŒ–
            --control-flow-flattening-threshold 0.75  # æ§åˆ¶æµå¹³å¦åŒ–é˜ˆå€¼
            --identifier-names-generator hexadecimal  # æ ‡è¯†ç¬¦åç§°ç”Ÿæˆå™¨
          echo "âœ… æ··æ·†å®Œæˆå¹¶ä¿å­˜ä¸º æ··æ·†/$OUTPUT_NAME"

      - name: æäº¤ç»“æœ
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ æ··æ·†ä»£ç å¹¶é‡å‘½åä¸º worker.js"
          files: |
            æ··æ·†/worker.js
            unobfuscated/
