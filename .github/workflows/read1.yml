name: BPB Panel 资产混淆与重命名
on:
  workflow_dispatch:
    inputs:
      run-type:
        description: "混淆阶段（base/medium/high）"
        required: true
        default: "base"
        options: ["base", "medium", "high"]  # 基础→中等→高强度
      comment:
        description: "调试备注"
        required: false
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *"

permissions:
  contents: write

jobs:
  build-obfuscate:
    runs-on: macos-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 安装混淆工具
        run: npm install -g javascript-obfuscator

      - name: 动态生成混淆参数
        run: |
          # 定义各阶段参数（按强度递增）
          case "${{ github.event.inputs.run-type }}" in
            "base")
              # 基础阶段：仅压缩+变量名混淆
              PARAMS="--compact true --identifier-names-generator hexadecimal"
              ;;
            "medium")
              # 中等阶段：增加字符串数组加密+死代码注入
              PARAMS="--compact true --identifier-names-generator hexadecimal \
                      --string-array true --string-array-encoding 'rc4' \
                      --dead-code-injection true --dead-code-injection-threshold 0.3"
              ;;
            "high")
              # 高强度阶段：开启控制流平坦化+调试保护
              PARAMS="--compact true --identifier-names-generator hexadecimal \
                      --string-array true --string-array-encoding 'rc4' \
                      --dead-code-injection true --dead-code-injection-threshold 0.5 \
                      --control-flow-flattening true --control-flow-flattening-threshold 0.7 \
                      --debug-protection true"
              ;;
            *)
              echo "❌ 无效的 run-type: ${{ github.event.inputs.run-type }}"
              exit 1
              ;;
          esac
          echo "PARAMS=$PARAMS" >> "$GITHUB_ENV"  # 写入环境变量供后续步骤使用

      - name: 下载并处理资产（示例，可替换为你的文件路径逻辑）
        run: |
          # 假设待混淆文件为仓库内的 src/worker.js
          SOURCE_FILE="./src/worker.js"
          if [[ ! -f "$SOURCE_FILE" ]]; then
            echo "❌ 未找到源文件: $SOURCE_FILE"
            exit 1
          fi
          mkdir -p obfuscated
          javascript-obfuscator "$SOURCE_FILE" --output "obfuscated/worker.js" $PARAMS
          echo "✅ 混淆完成（阶段: ${{ github.event.inputs.run-type }}）"

      - name: 提交结果
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "🔄 混淆阶段: ${{ github.event.inputs.run-type }} | ${{ github.event.inputs.comment }}"
          files: |
            obfuscated/worker.js
