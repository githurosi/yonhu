name: BPB Panel èµ„äº§æ··æ·†ä¸é‡å‘½å
on:
  workflow_dispatch:
    inputs:
      run-type:
        description: "è¿è¡Œæ¨¡å¼ï¼ˆnormal/debugï¼‰"
        required: true
        default: "normal"
        options: ["normal", "debug"]
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *"

permissions:
  contents: write

jobs:
  build-obfuscate:
    runs-on: macos-latest
    steps:
      - name: æ£€å‡ºä»“åº“ï¼ˆä»…ç”¨äºæäº¤ç»“æœï¼Œä¸ä¾èµ–æœ¬åœ°ä»£ç ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: å®‰è£…æ··æ·†å·¥å…·
        run: npm install -g javascript-obfuscator

      - name: ä¸‹è½½èµ„äº§å¹¶åœ¨æœåŠ¡å™¨ä¸´æ—¶ç›®å½•å¤„ç†
        run: |
          REPO_OWNER="bia-pain-bache"
          REPO_NAME="BPB-Worker-Panel"
          TMP_DIR=$(mktemp -d)  # åˆ›å»ºæœåŠ¡å™¨ä¸´æ—¶ç›®å½•ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
          cd "$TMP_DIR"          # è¿›å…¥ä¸´æ—¶ç›®å½•æ“ä½œ

          # ä¸‹è½½å¹¶è§£å‹èµ„äº§ï¼ˆæ‰€æœ‰æ“ä½œåœ¨æœåŠ¡å™¨ä¸´æ—¶ç©ºé—´å®Œæˆï¼‰
          response=$(curl -s https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases/latest)
          DOWNLOAD_URL=$(echo "$response" | jq -r '.assets[] | select(.name == "worker.zip") | .browser_download_url')
          curl -sL "$DOWNLOAD_URL" -o worker.zip
          unzip -q worker.zip

          # å®šä½æœªæ··æ·†æ–‡ä»¶
          SOURCE_FILE=$(find . -type f -name "*.js" | grep -v "_obfuscated.js" | head -n 1)
          if [[ -z "$SOURCE_FILE" ]]; then
            echo "âŒ æœªæ‰¾åˆ°æœªæ··æ·†çš„JSæ–‡ä»¶"
            exit 1
          fi

          # æ‰§è¡Œæ··æ·†
          mkdir -p obfuscated
          OUTPUT_NAME="worker.js"
          if [[ "${{ github.event.inputs.run-type }}" == "debug" ]]; then
            DEBUG_PARAM="--dead-code-injection-threshold 0.2 --control-flow-flattening false"
          else
            DEBUG_PARAM=""
          fi
          javascript-obfuscator "$SOURCE_FILE" --output "obfuscated/$OUTPUT_NAME" \
            --compact true \
            --dead-code-injection true \
            --identifier-names-generator hexadecimal \
            --string-array true \
            --string-array-encoding 'rc4' \
            $DEBUG_PARAM

          # å°†æ··æ·†ç»“æœå¤åˆ¶åˆ°ä»“åº“ç›®å½•ï¼ˆGITHUB_WORKSPACEï¼‰
          cp -r "$TMP_DIR/obfuscated" "$GITHUB_WORKSPACE/"
          echo "âœ… æ··æ·†ç»“æœå·²ä»æœåŠ¡å™¨ä¸´æ—¶ç›®å½•åŒæ­¥åˆ°ä»“åº“ç›®å½•"

      - name: æäº¤æ··æ·†ç»“æœåˆ°ä»“åº“
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ æœåŠ¡å™¨ç«¯æ··æ·†å®Œæˆ | æ¨¡å¼: ${{ github.event.inputs.run-type }}"
          files: |
            obfuscated/worker.js
