name: BPB Panel èµ„äº§æ··æ·†ä¸é‡å‘½å
on:
  # æ‰‹åŠ¨è§¦å‘ï¼ˆå¸¦å‚æ•°ï¼‰
  workflow_dispatch:
    inputs:
      run-type:
        description: "è¿è¡Œæ¨¡å¼ï¼ˆnormal/debugï¼‰"
        required: true
        default: "normal"
        options: ["normal", "debug"]
      comment:
        description: "æ‰‹åŠ¨è¿è¡Œå¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"
        required: false
        default: ""
  # è‡ªåŠ¨è§¦å‘ï¼ˆä»£ç æ¨é€/å®šæ—¶ä»»åŠ¡ï¼‰
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *"  # æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨è¿è¡Œ

permissions:
  contents: write

jobs:
  build-obfuscate:
    runs-on: macos-latest  # æŒ‡å®š macOS ç³»ç»Ÿ
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # æ‹‰å–æœ€æ–°ä»£ç ï¼Œå‡å°‘å†—ä½™æ•°æ®

      - name: æ‰“å°è§¦å‘ç±»å‹å’Œ Runner è§„æ ¼
        run: |
          # æ‰“å°è§¦å‘æ–¹å¼
          echo "===== è§¦å‘ä¿¡æ¯ ====="
          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            echo "æ‰‹åŠ¨è§¦å‘ | æ¨¡å¼: ${{ github.event.inputs.run-type }}"
            echo "å¤‡æ³¨: ${{ github.event.inputs.comment }}"
          else
            echo "è‡ªåŠ¨è§¦å‘ | äº‹ä»¶: $GITHUB_EVENT_NAME"
          fi
          # æ‰“å° Runner è§„æ ¼ï¼ˆCPU/å†…å­˜ï¼‰
          echo "\n===== macOS Runner è§„æ ¼ ====="
          sysctl -n machdep.cpu.brand_string  # CPU å‹å·
          sysctl -n hw.logicalcpu              # é€»è¾‘æ ¸å¿ƒæ•°
          sysctl -n hw.memsize | awk '{printf "å†…å­˜: %.2f GB\n", $1/1024/1024/1024}'  # è½¬æ¢ä¸º GB
          echo "=========================="

      - name: å®‰è£…æ··æ·†å·¥å…·
        run: npm install -g javascript-obfuscator  # å®‰è£… javascript-obfuscator

      - name: ä¸‹è½½å¹¶è§£å‹èµ„äº§
        run: |
          REPO_OWNER="bia-pain-bache"
          REPO_NAME="BPB-Worker-Panel"
          rm -rf unobfuscated/*  # æ¸…ç©ºæ—§æ–‡ä»¶
          # è·å–æœ€æ–°ç‰ˆæœ¬èµ„äº§é“¾æ¥
          response=$(curl -s https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases/latest)
          DOWNLOAD_URL=$(echo "$response" | jq -r '.assets[] | select(.name == "worker.zip") | .browser_download_url')
          if [[ -z "$DOWNLOAD_URL" ]]; then
            echo "âŒ æœªæ‰¾åˆ° worker.zip"
            exit 1
          fi
          mkdir -p unobfuscated  # åˆ›å»ºè§£å‹ç›®å½•
          curl -sL "$DOWNLOAD_URL" -o unobfuscated/worker.zip  # ä¸‹è½½æ–‡ä»¶
          unzip -q unobfuscated/worker.zip -d unobfuscated/  # é™é»˜è§£å‹
          echo "âœ… èµ„äº§è§£å‹å®Œæˆ"

      - name: æ··æ·†å¹¶é‡å‘½åæ–‡ä»¶
        run: |
          mkdir -p æ··æ·†  # åˆ›å»ºæ··æ·†ç»“æœç›®å½•
          # å®šä½æœªæ··æ·†çš„ JS æ–‡ä»¶ï¼ˆæ’é™¤å·²æ··æ·†çš„æ–‡ä»¶ï¼‰
          SOURCE_FILE=$(find unobfuscated -type f -name "*.js" | grep -v "_obfuscated.js" | head -n 1)
          if [[ -z "$SOURCE_FILE" ]]; then
            echo "âŒ æœªæ‰¾åˆ°æœªæ··æ·†çš„ JS æ–‡ä»¶"
            exit 1
          fi
          OUTPUT_NAME="worker.js"  # ç›®æ ‡æ–‡ä»¶å
          # æ ¹æ®è¿è¡Œæ¨¡å¼è°ƒæ•´æ··æ·†å‚æ•°ï¼ˆè°ƒè¯•æ¨¡å¼é™ä½å¼ºåº¦ï¼‰
          if [[ "${{ github.event.inputs.run-type }}" == "debug" ]]; then
            DEBUG_PARAM="--dead-code-injection-threshold 0.2 --control-flow-flattening false"
            echo "ğŸš§ è°ƒè¯•æ¨¡å¼ï¼šå·²é™ä½æ··æ·†å¼ºåº¦"
          else
            DEBUG_PARAM=""
          fi
          # æ‰§è¡Œæ··æ·†å‘½ä»¤
          javascript-obfuscator "$SOURCE_FILE" --output "æ··æ·†/$OUTPUT_NAME" \
            --compact true \
            --dead-code-injection true \
            --identifier-names-generator hexadecimal \
            --string-array true \
            --string-array-encoding 'rc4' \
            $DEBUG_PARAM  # åŠ¨æ€æ³¨å…¥å‚æ•°
          echo "âœ… æ··æ·†å®Œæˆå¹¶ä¿å­˜ä¸ºï¼šæ··æ·†/$OUTPUT_NAME"

      - name: æäº¤ç»“æœåˆ°ä»“åº“
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ æ··æ·†ä»£ç  | è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          files: |
            æ··æ·†/worker.js
            unobfuscated/
          commit_options: "--no-verify"  # è·³è¿‡ Git é’©å­éªŒè¯ï¼ˆå¯é€‰ï¼‰
