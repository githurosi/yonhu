name: Code Obfuscation Workflow

on:
  workflow_dispatch:
    inputs:
      description:
        description: '触发代码混淆工作流的原因'
        required: false
        default: '手动触发'
  push:
    branches: [ main ]

jobs:
  obfuscate-code:
    runs-on: macos-15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Display trigger information
      run: |
        echo "Workflow Trigger Information:"
        echo "-----------------------------"
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "Triggered by: Manual Dispatch"
          echo "Reason: ${{ github.event.inputs.description || 'No description provided' }}"
        else
          echo "Triggered by: Push to main branch"
        fi
        echo "-----------------------------"

    - name: Download worker.zip from release assets
      run: |
        RELEASE_URL="https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases/latest"
        DOWNLOAD_URL=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" $RELEASE_URL | grep -o 'https://[^"]*worker.zip"')
        if [ -z "$DOWNLOAD_URL" ]; then
          echo "Error: Failed to find worker.zip download URL."
          exit 1
        fi
        echo "Downloading from: $DOWNLOAD_URL"
        curl -L -o worker.zip "$DOWNLOAD_URL" || { echo "Error: Failed to download worker.zip"; exit 1; }

    - name: Unzip worker.zip
      run: unzip worker.zip -d worker_unzipped || { echo "Error: Failed to unzip worker.zip"; exit 1; }

    - name: Install Python obfuscation tool (pyobfuscate)
      run: pip3 install pyobfuscate || { echo "Error: Failed to install pyobfuscate"; exit 1; }

    - name: Obfuscate Python code (low level)
      run: find worker_unzipped -name "*.py" -exec pyobfuscate --level low {} \; || { echo "Error: Failed to obfuscate Python files"; exit 1; }

    - name: Move obfuscated files to repository root
      run: rsync -av --exclude='.git' worker_unzipped/ . || { echo "Error: Failed to move obfuscated files"; exit 1; }

    - name: Commit and push changes
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        git add .
        git commit -m "Add obfuscated worker files" || { echo "Error: Failed to commit changes"; exit 1; }
        git push origin main || { echo "Error: Failed to push changes"; exit 1; }
