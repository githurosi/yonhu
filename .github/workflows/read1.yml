name: BPB Panel èµ„äº§æ··æ·†
on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *" 

permissions:
  contents: write

jobs:
  build-obfuscate:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…UglifyJS
        run: |
          npm install -g uglify-js

      - name: æ··æ·†å¹¶ä¸‹è½½æ–‡ä»¶
        run: |
          REPO_OWNER="bia-pain-bache"
          REPO_NAME="BPB-Worker-Panel"
          response=$(curl -s https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases/latest)
          DOWNLOAD_URL=$(echo "$response" | jq -r '.assets[] | select(.name == "worker.zip") | .browser_download_url')
          if [[ -z "$DOWNLOAD_URL" ]]; then
            echo "âŒ æœªæ‰¾åˆ° worker.zip"
            exit 1
          fi
          # ä¸‹è½½worker.zipåˆ°ä¸´æ—¶ç›®å½•
          TMP_DIR=$(mktemp -d)
          curl -sL "$DOWNLOAD_URL" -o "$TMP_DIR/worker.zip"
          unzip -q "$TMP_DIR/worker.zip" -d "$TMP_DIR"
          # æŸ¥æ‰¾æœªæ··æ·†çš„JSæ–‡ä»¶
          SOURCE_FILE=$(find "$TMP_DIR" -type f -name "*.js" | grep -v "_obfuscated.js" | head -n 1)
          if [[ -z "$SOURCE_FILE" ]]; then
            echo "âŒ æœªæ‰¾åˆ°æœªæ··æ·†çš„JSæ–‡ä»¶"
            exit 1
          fi
          # è¿›è¡Œæ··æ·†
          OUTPUT_FILE="${SOURCE_FILE%.*}_obfuscated.js"
          uglifyjs "$SOURCE_FILE" -o "$OUTPUT_FILE" \
            --mangle \
            --compress \
            --output beautify=false \
            --output comments=false \
            --toplevel \
            --dead_code_inline
          # ä¸‹è½½æ··æ·†åçš„æ–‡ä»¶åˆ°ä½ æŒ‡å®šçš„å·¥å…·ä½ç½®ï¼ˆå‡è®¾ä¸ºå½“å‰ä»“åº“çš„obfuscatedç›®å½•ï¼‰
          mkdir -p obfuscated
          mv "$OUTPUT_FILE" obfuscated/
          echo "âœ… æ··æ·†å®Œæˆå¹¶ä¿å­˜åˆ°obfuscatedç›®å½•"

      - name: æäº¤ç»“æœ
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ å®ŒæˆBPB Panelèµ„äº§æ··æ·†"
          files: |
            obfuscated/
