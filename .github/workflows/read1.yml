name: BPB Panel èµ„äº§æ··æ·†ä¸é‡å‘½å
on:
  workflow_dispatch:
    inputs:
      run-type:
        description: "æ··æ·†é˜¶æ®µï¼ˆbase/medium/highï¼‰"
        required: true
        default: "base"
        options: ["base", "medium", "high"]  # åŸºç¡€â†’ä¸­ç­‰â†’é«˜å¼ºåº¦
      comment:
        description: "è°ƒè¯•å¤‡æ³¨"
        required: false
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *"

permissions:
  contents: write

jobs:
  build-obfuscate:
    runs-on: macos-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: å®‰è£…æ··æ·†å·¥å…·
        run: npm install -g javascript-obfuscator

      - name: åŠ¨æ€ç”Ÿæˆæ··æ·†å‚æ•°
        run: |
          # å®šä¹‰å„é˜¶æ®µå‚æ•°ï¼ˆæŒ‰å¼ºåº¦é€’å¢ï¼‰
          case "${{ github.event.inputs.run-type }}" in
            "base")
              # åŸºç¡€é˜¶æ®µï¼šä»…å‹ç¼©+å˜é‡åæ··æ·†
              PARAMS="--compact true --identifier-names-generator hexadecimal"
              ;;
            "medium")
              # ä¸­ç­‰é˜¶æ®µï¼šå¢åŠ å­—ç¬¦ä¸²æ•°ç»„åŠ å¯†+æ­»ä»£ç æ³¨å…¥
              PARAMS="--compact true --identifier-names-generator hexadecimal \
                      --string-array true --string-array-encoding 'rc4' \
                      --dead-code-injection true --dead-code-injection-threshold 0.3"
              ;;
            "high")
              # é«˜å¼ºåº¦é˜¶æ®µï¼šå¼€å¯æ§åˆ¶æµå¹³å¦åŒ–+è°ƒè¯•ä¿æŠ¤
              PARAMS="--compact true --identifier-names-generator hexadecimal \
                      --string-array true --string-array-encoding 'rc4' \
                      --dead-code-injection true --dead-code-injection-threshold 0.5 \
                      --control-flow-flattening true --control-flow-flattening-threshold 0.7 \
                      --debug-protection true"
              ;;
            *)
              echo "âŒ æ— æ•ˆçš„ run-type: ${{ github.event.inputs.run-type }}"
              exit 1
              ;;
          esac
          echo "PARAMS=$PARAMS" >> "$GITHUB_ENV"  # å†™å…¥ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨

      - name: ä¸‹è½½å¹¶å¤„ç†èµ„äº§ï¼ˆç¤ºä¾‹ï¼Œå¯æ›¿æ¢ä¸ºä½ çš„æ–‡ä»¶è·¯å¾„é€»è¾‘ï¼‰
        run: |
          # å‡è®¾å¾…æ··æ·†æ–‡ä»¶ä¸ºä»“åº“å†…çš„ src/worker.js
          SOURCE_FILE="./src/worker.js"
          if [[ ! -f "$SOURCE_FILE" ]]; then
            echo "âŒ æœªæ‰¾åˆ°æºæ–‡ä»¶: $SOURCE_FILE"
            exit 1
          fi
          mkdir -p obfuscated
          javascript-obfuscator "$SOURCE_FILE" --output "obfuscated/worker.js" $PARAMS
          echo "âœ… æ··æ·†å®Œæˆï¼ˆé˜¶æ®µ: ${{ github.event.inputs.run-type }}ï¼‰"

      - name: æäº¤ç»“æœ
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ æ··æ·†é˜¶æ®µ: ${{ github.event.inputs.run-type }} | ${{ github.event.inputs.comment }}"
          files: |
            obfuscated/worker.js
